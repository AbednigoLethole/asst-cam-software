name: ASTT pipeline

# Triggers the pipeline on every push.
on:
  push:
    branches:
      - '*' 

jobs:
  build-image:
    runs-on: ubuntu-20.04
    env:
      ASTT_USR: ${{ secrets.ASTT_USR }}
      ASTT_PASS: ${{ secrets.ASTT_PASS }}


    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Build the ASTT Docker Image
        run: docker build -t ghcr.io/abednigolethole/astt-cam-software .

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.ASTT_PASS }}" | docker login ghcr.io --username "${{ secrets.ASTT_USR }}" --password-stdin
        env:
          ASTT_USR: ${{ secrets.ASTT_USR }}
          ASTT_PASS: ${{ secrets.ASTT_PASS }}
      
      - name: Push the astt docker image to GitHub Container Registry
        run: docker push ghcr.io/abednigolethole/astt-cam-software:latest


  python-lint:
    runs-on: ubuntu-20.04
    needs: build-image

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install poetry # Installing poetry
        poetry config virtualenvs.create false && poetry install
        
    - name: Checks if the code is of good quality using isort
      run: isort --check-only --profile black --line-length 70 -w 70 src/

    - name: Checks if the code is of good quality using black
      run: black --exclude .+\.ipynb --check --line-length 70 --line-length 70 src/

    - name: Checks if the code is of good quality using flake8
      run: flake8 --show-source --statistics --max-line-length 70 --max-line-length=70 src/ 

  test:
    runs-on: ubuntu-20.04
    needs: python-lint 

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Login to GitHub Container Registry
      run: echo "${{ secrets.ASTT_PASS }}" | docker login ghcr.io --username "${{ secrets.ASTT_USR }}" --password-stdin
    
    - name: Pull image with the ASTT simulator
      run: docker pull ghcr.io/abednigolethole/astt-cam-software

    - name: Adding VCAN module
      run: sudo apt-get install linux-modules-extra-$(uname -r)


    - name: Starting VCAN Network
      run: sudo sh startVirtualCANInterface.sh

    - name: Run the simulator
      run: docker run -it --network=host ghcr.io/abednigolethole/astt-cam-software 

    - name: Run Tests
      run: echo "Will test once the tests are available"

  docs-build:
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: builds the docs
      run: echo "Will build the docs"

  publish:
    runs-on: ubuntu-20.04
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Publish artifact
      run: echo "Will publish the asst software."
    